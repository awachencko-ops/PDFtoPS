# Модернизация PDFtoPS: анализ, риски, план работ

## 1) Что есть сейчас
- Приложение WinForms, .NET 7, пакетная конвертация PDF -> PS через два запуска Ghostscript (pdfwrite, затем ps2write).
- Обработка файлов выполняется **последовательно** в UI-потоке (через `foreach` в обработчике кнопки).
- Вызов Ghostscript выполняется через `ProcessStartInfo`.

## 2) Ключевые конфликтные зоны
1. **Жестко заданный путь к Ghostscript**
   - При обновлении версии или нестандартной установке конвертация не стартует.
2. **Риск зависания процесса Ghostscript**
   - При проблемных PDF процесс может зависнуть без таймаута.
3. **Риск блокировки из-за чтения stdout/stderr**
   - Синхронный `ReadToEnd` потенциально может приводить к deadlock в некоторых сценариях.
4. **Отсутствие ретраев**
   - Временные сбои I/O или race-condition дают фатальный отказ без повторной попытки.
5. **Нет централизованного логирования**
   - Сложно анализировать причины падений у пользователей.
6. **Заявленная “многопоточность” не реализована**
   - Конвертация идет строго последовательно в UI-потоке.

## 3) Что нужно сделать для стабильной работы Ghostscript
- Добавить авто-поиск `gswin64c.exe/gswin32c.exe` + поддержку `GHOSTSCRIPT_PATH`.
- Добавить защитные флаги запуска (`-dSAFER -dNOPROMPT`) и таймаут выполнения.
- Перевести захват stdout/stderr на асинхронный режим (`BeginOutputReadLine/BeginErrorReadLine`).
- Добавить 1–2 повторные попытки запуска при ошибке.
- Проверять факт создания выходного `.ps` файла даже при `ExitCode == 0`.

## 4) План модернизации (backlog)

### Этап A — Стабилизация (в первую очередь)
- [x] Вынести логику запуска Ghostscript в отдельный сервис `GhostscriptRunner`.
- [x] Добавить structured-логирование в файл (`logs/yyyyMMdd.log`).
- [x] Добавить таймауты и ретраи (реализовано в `GhostscriptRunner`).
- [x] Добавить коды ошибок и понятные сообщения в UI.

### Этап B — Реальная многопоточность
- [x] Перевести конвертацию на `Task.Run` + `CancellationToken`.
- [x] Ограничить параллелизм через `SemaphoreSlim` (2 потока по умолчанию).
- [x] Добавить безопасное обновление UI через `Invoke`/`BeginInvoke`.
- [x] Реализовать кнопку “Отмена” для пачки (переключение кнопки Convert в режим отмены).

### Этап C — Устранение архитектурных конфликтов
- [ ] Разделить UI и доменную логику (WinForms слой / сервисы / модели).
- [x] Вынести профили и параметры в JSON-конфиг (`appsettings.json`).
- [ ] Покрыть критическую логику unit/integration тестами.
- [x] Добавить предварительную валидацию PDF (битые/защищенные документы).

### Этап D — Надежность поставки
- [x] Добавить health-check Ghostscript при старте приложения.
- [x] Поддержать portable-режим с локальным `gs` рядом с exe.
- [x] Зафиксировать поддерживаемые версии Ghostscript в документации (`GHOSTSCRIPT_SUPPORT.md`).

## 5) Предлагаемые KPI после модернизации
- Crash-free rate > 99.5% на пакетах до 100 файлов.
- Время восстановления после сбоя одного файла: без остановки всей пачки.
- Диагностируемость: по логам понятна первопричина каждой ошибки.
